# PGMM 缺电救援建议（Rescue Advisor）说明

本文档说明“缺电救援建议”模块的目标、判断逻辑与输出形式，便于二次优化（例如：更精准的正电岛边界、更多类型的救援动作等）。

---

## 1) 功能目标

当电网持续为负电时，提供“恢复正电”的建议，并在：

- 小地图 / 全屏地图：标出建议
- 主游戏画面：直接绘制建议（无鼠标交互）

当前实现支持两类建议：

1) **正电岛隔离建议**：断开某条电力链接后，某一侧成为可自洽的正电区域，使用多边形圈出该区域。
2) **冲击反应堆禁用建议**：当禁用若干个“净耗电”的冲击反应堆即可让电网回正电时，优先给出该方案并标记建议禁用的反应堆。

---

## 2) 去抖/清除策略（避免反复提示）

设置项：`pgmm-rescue-clearwindow`（k 秒）

- 为每个 `PowerGraph` 维护一个滑动窗口（ring buffer），记录最近 k 秒内的 `powerBalance(/s)` 采样。
- 计算窗口最小值 `minBalance`：
  - 若 `minBalance > 0`：说明该窗口内始终为正电，可自动清除救援提示。

目的：解决“电力一会负一会正导致提示反复出现”的噪音问题。

---

## 3) 正电岛计算与多边形圈选

核心步骤：

1) 枚举候选“可断开的电力链接”（目前主要针对 PowerNode 激光链接）。
2) 对每条候选边，分别在“假设断开”情况下做 BFS 计算两侧 component 的：
   - 产电（produced）
   - 需电（needed）
   - 储能（stored）
3) 若某一侧的 `produced - needed` 为正（且满足一些过滤条件），作为正电岛候选。
4) 为了在世界/地图上圈出区域：
   - 收集 BFS 访问到的所有 tile 的四个角点
   - 计算这些角点的凸包（convex hull）
   - 以凸包多边形作为“正电岛轮廓”（速度快，但可能包含空洞/凹陷区域）

---

## 4) 冲击反应堆禁用建议

- 扫描电网内所有 `Blocks.impactReactor`
- 计算每个反应堆的每秒净贡献：
  - `net = produced - needed`
  - 只对 `net < 0`（净耗电）的反应堆给出禁用建议（避免误伤净发电的反应堆）
- 按“禁用带来的改善值”排序，取最小数量的前缀使改善总和覆盖 deficit
- 若无法完全覆盖 deficit，则不输出该方案（避免给出无效建议）

---

## 5) 输出与绘制

- Rescue 提示会写入 `RescueAlert`，携带：
  - 多边形 hull + bbox + centroid（文本标签位置）
  - ImpactDisableHint 列表（位置 + rank）
- 绘制入口见 `pgmm_overlays_dox.md`：
  - 世界叠加：多边形线框 + `#rank + net/s` 文本
  - Impact：方框标记 + `!rank`

